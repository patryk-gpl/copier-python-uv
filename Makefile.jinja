.PHONY: help install clean{% if "pytest" in dev_deps %} test{% endif %}

help: ## Display available commands
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

check: ## Verify required tools are available
	@set -eu; \
	for cmd in uv pre-commit; do \
	  if ! command -v "$$cmd" >/dev/null 2>&1; then \
		printf "ERROR: %s missing — install it\n" "$$cmd" >&2; \
		exit 1; \
	  fi; \
	done; \
	printf "Prerequisites OK\n"

install: check ## Install project dependencies
	@pre-commit install
	@uv sync --extra dev

{% if "pytest" in dev_deps -%}
test: ## Run all unit tests
	@set -eu; \
	if [[ ! -d ".venv" ]]; then \
	  printf "ERROR: .venv not found — run 'make install' first\n" >&2; \
	  exit 1; \
	fi; \
	uv run pytest tests/unit/
{% endif -%}

clean: ## Clean build artifacts
	@echo "Cleaning Python artifacts.."
	@rm -rf build/ dist/ *.egg-info/ .pytest_cache/ .ruff_cache/ htmlcov/ .coverage
	@find . -type d -name __pycache__ -exec rm -rf {} +
	@find . -type f -name "*.pyc" -delete
